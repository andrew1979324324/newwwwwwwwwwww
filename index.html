<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Gestione Lavoro Pro 2026 - Export Singolo</title>
<style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; background: #f0f2f5; color: #333; margin: 0; padding-bottom: 50px; }
    h1 { background: #1a73e8; color: white; margin: 0; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    #controls { margin: 20px; background: white; display: inline-block; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    #calendar-container { max-width: 850px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    #week-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; font-weight: bold; margin-bottom: 10px; color: #5f6368; }
    #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
    .day { background: #fff; border: 1px solid #e0e0e0; padding: 10px; border-radius: 8px; cursor: pointer; min-height: 80px; transition: 0.3s; display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start; font-size: 12px; }
    .day:hover:not(.empty) { transform: translateY(-2px); }
    .empty { background: #f8f9fa; border: none; cursor: default; }
    .day-number { font-weight: bold; font-size: 14px; margin-bottom: 4px; }
    #formBox, #summaryBox, #annualBox { display:none; background:white; max-width:90%; width: 850px; margin: 20px auto; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: left; }
    select, input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #dadce0; border-radius: 6px; }
    button { padding: 10px 15px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; margin: 5px; font-size: 13px; }
    .btn-save { background: #1a73e8; color: white; }
    .btn-copy { background: #34a853; color: white; }
    .btn-paste { background: #fbbc04; color: black; }
    .btn-delete { background: #ea4335; color: white; }
    .btn-excel { background: #1d6f42; color: white; font-size: 11px; padding: 5px 10px; }
    .btn-excel-main { background: #1d6f42; color: white; padding: 12px 20px; }
    .btn-close { background: #5f6368; color: white; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 12px; background: white; }
    th { background: #f8f9fa; color: #5f6368; font-weight: bold; border-bottom: 2px solid #dee2e6; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
    .row-service { font-weight: bold; display: flex; justify-content: space-between; align-items: center; padding: 8px 15px; border-radius:6px; margin-top:10px; }
    .total-final { background: #333; color: white; font-weight: bold; }
</style>
</head>
<body>
<h1>üìÖ Gestione Lavoro Pro 2026</h1>
<div id="controls">
  <label>Mese:</label>
  <select id="monthSelect" style="width: auto;"></select>
  <label> Anno: 2026</label>
</div>
<div id="calendar-container">
  <div id="week-days"><div>Lun</div><div>Mar</div><div>Mer</div><div>Gio</div><div>Ven</div><div>Sab</div><div>Dom</div></div>
  <div id="calendar"></div>
</div>
<div style="margin-top: 20px;">
  <button class="btn-save" style="padding: 15px 30px;" onclick="showSummary()">üìä Consuntivo Analitico & Export</button>
  <button class="btn-copy" onclick="showAnnualSummary()">üìà Media e Progressivi</button>
</div>
<div id="formBox">
  <h3 id="selectedDate"></h3>
  <div style="margin-bottom: 10px;">
    <button class="btn-copy" onclick="copyData()">üìã Copia Dati</button>
    <button id="pasteBtn" class="btn-paste" onclick="pasteData()" style="display:none;">üì• Incolla</button>
  </div>
  <label>Societ√†</label><select id="client"></select>
  <label>Location</label><select id="location"></select>
  <label>Ora Inizio</label><select id="startTime"></select>
  <label>Ora Fine</label><select id="endTime"></select>
  <label>Pausa pranzo</label>
  <select id="lunchBreak"><option value="si">S√¨</option><option value="no">No</option></select>
  <div id="dayLiveRes" style="padding:10px; background:#e8f0fe; border-radius:5px; margin-top:10px; font-weight:bold;"></div>
  <hr>
  <button class="btn-save" onclick="saveData()">üíæ Salva</button>
  <button id="deleteBtn" class="btn-delete" onclick="deleteData()">üóëÔ∏è Elimina</button>
  <button class="btn-close" onclick="closeAll()">Chiudi</button>
</div>
<div id="summaryBox">
  <h3 id="summaryTitle">Consuntivo</h3>
  <div id="summaryContent" style="overflow-x: auto;"></div>
  <div style="margin-top: 20px; border-top: 2px solid #eee; padding-top: 15px;">
    <button class="btn-excel-main" onclick="exportDetailedExcel('tutti')">üíæ Esporta Tutto il Mese (Unico File)</button>
    <button class="btn-close" onclick="closeAll()">Chiudi</button>
  </div>
</div>
<div id="annualBox">
  <h3>Statistiche 2026</h3>
  <div id="annualContent"></div>
  <button class="btn-close" onclick="closeAll()">Chiudi</button>
</div>
<script>
const companies = ["Anteprima Video","Airone","Av Set","B-Nomio","Centro Pilota","Ciccarelli","Dafral Soundvision","De Simoni","Digital Network","DHS","F.A.R.E. Servizi","Gruppo Planet","HRC","Ifet","Livon","Lvs","Milani group","Mondialtecnica","Niutek","Onegroup","Sincronismi","Studiovisio","TCS 2000","Tecnoconference Roma","Tecnomeeting","Vms"];
const locations = ["Anantara","Angelicum","A. Roma Lifestyle","Acquario Romano","Auditorium P.d. Musica","Bernini Bristol","H. Massimo d'Azeglio","Cardo Roma","Chiostro Del Bramante","Don Giovanni (Praga)","Fao","Hotel Vanvitelli","Ergife Palace Hotel","Esperienza Europa","Eurostars Roma Aeterna","Fiera di Bologna","Hotel D. Camilla Savelli","H. Barcel√≤ Mantegna","H. Bulgari","H. Dei Mellini","H. Le Merdien Visconti","H. Parco de Principi","Hotel Plaza","Holiday Inn Rome","H. Rome Airport","H. Rome Eur La Lama","H. Nazionale","H. Ripa","Boutique Calzavecchio","MOMEC","Nhow","Nh Centro","Nh Villa Carpegna","Nh Giustiniano","La Nuvola","Palazzo dell'INPS","Parlamento Europeo Italia","Rome Marriot P.H.","Rome Cavalieri","Salone delle Fontane","S. Rome P. De' Medici","StarHotels Metropole","Starhotels Excelsior (Bo)","StarHotels Michelangelo (Fi)","Spazio 900","Spazio Sette Libreria","The Hive Hotel","The Westin Warsaw","The Westin Excelsior Rome","The St. Regis Rome","The Space Cinema Moderno","Tempio di Adriano","Villa Miani","Studio Curtis","Villa Madama"];
const months = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
let currentMonth = new Date().getMonth();
let currentYear = 2026;
let clipboard = null;
const clientSel = document.getElementById("client");
const locSel = document.getElementById("location");
const startSel = document.getElementById("startTime");
const endSel = document.getElementById("endTime");
const lunchSel = document.getElementById("lunchBreak");
const monthSel = document.getElementById("monthSelect");
companies.sort().forEach(c => clientSel.add(new Option(c, c)));
locations.sort().forEach(l => locSel.add(new Option(l, l)));
months.forEach((m, i) => monthSel.add(new Option(m, i)));
monthSel.value = currentMonth;
for(let h=0; h<24; h++) {["00","30"].forEach(m => {let val = `${h.toString().padStart(2,'0')}:${m}`; startSel.add(new Option(val, val)); endSel.add(new Option(val, val));});}
function getColorForCompany(name){
    let hash = 0;
    for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
    const hue = hash % 360;
    return `hsl(${hue},70%,85%)`;
}
function getBorderColor(name){
    let hash = 0;
    for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
    const hue = hash % 360;
    return `hsl(${hue},70%,45%)`;
}
function getStats(start, end, lunch) {
    const s = new Date(`1970-01-01T${start}`);
    const e = new Date(`1970-01-01T${end}`);
    let diff = (e - s) / (1000 * 60 * 60);
    if (diff < 0) diff += 24;
    const soglia = lunch === 'no' ? 8 : 9;
    const stra = Math.max(0, diff - soglia);
    const lordo = 250 + (stra * 25);
    return { ore: diff, stra: stra, lordo: lordo, netto: lordo * 0.74 };
}
function renderCalendar() {
    const cal = document.getElementById("calendar"); cal.innerHTML = "";
    currentMonth = parseInt(monthSel.value);
    let firstDay = new Date(currentYear, currentMonth, 1).getDay();
    let offset = firstDay === 0 ? 6 : firstDay - 1;
    let daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    for(let i=0; i<offset; i++) cal.appendChild(Object.assign(document.createElement("div"), {className: "day empty"}));
    for(let i=1; i<=daysInMonth; i++) {
        const key = `${currentYear}-${currentMonth+1}-${i}`;
        const data = JSON.parse(localStorage.getItem(key));
        const div = document.createElement("div");
        div.className = "day";
        div.onclick = () => openDay(i);
        div.innerHTML = `<div class="day-number">${i}</div>`;
        if(data) {
            const bg = getColorForCompany(data.client);
            const border = getBorderColor(data.client);
            div.style.background = bg;
            div.style.borderLeft = `6px solid ${border}`;
            div.innerHTML += `<div style="font-weight:bold;">${data.client}</div>`;
        }
        cal.appendChild(div);
    }
}
function openDay(day) {
    const key = `${currentYear}-${currentMonth+1}-${day}`;
    document.getElementById("formBox").style.display = "block";
    document.getElementById("formBox").dataset.key = key;
    document.getElementById("selectedDate").innerText = `${day} ${months[currentMonth]} 2026`;
    const data = JSON.parse(localStorage.getItem(key));
    if(data) {
        clientSel.value = data.client; locSel.value = data.location;
        startSel.value = data.startTime; endSel.value = data.endTime;
        lunchSel.value = data.lunchBreak || 'si';
        document.getElementById("deleteBtn").style.display = "inline-block";
    } else {
        startSel.value = "08:00"; endSel.value = "17:00"; lunchSel.value = 'si';
        document.getElementById("deleteBtn").style.display = "none";
    }
    updateLiveRes();
}
function updateLiveRes() {
    const res = getStats(startSel.value, endSel.value, lunchSel.value);
    document.getElementById("dayLiveRes").innerText = `Lordo: ‚Ç¨${res.lordo.toFixed(2)} (Straordinari: ${res.stra.toFixed(1)}h)`;
}
startSel.onchange = updateLiveRes; endSel.onchange = updateLiveRes; lunchSel.onchange = updateLiveRes;
function saveData() {
    localStorage.setItem(document.getElementById("formBox").dataset.key, JSON.stringify({ client: clientSel.value, location: locSel.value, startTime: startSel.value, endTime: endSel.value, lunchBreak: lunchSel.value }));
    closeAll(); renderCalendar();
}
function deleteData() { if(confirm("Eliminare?")) { localStorage.removeItem(document.getElementById("formBox").dataset.key); closeAll(); renderCalendar(); } }
function copyData() { clipboard = { client: clientSel.value, location: locSel.value, startTime: startSel.value, endTime: endSel.value, lunchBreak: lunchSel.value }; document.getElementById("pasteBtn").style.display = "inline-block"; }
function pasteData() { if(clipboard) { clientSel.value = clipboard.client; locSel.value = clipboard.location; startSel.value = clipboard.startTime; endSel.value = clipboard.endTime; lunchSel.value = clipboard.lunchBreak || 'si'; updateLiveRes(); } }
function closeAll() { document.getElementById("formBox").style.display = "none"; document.getElementById("summaryBox").style.display = "none"; document.getElementById("annualBox").style.display = "none"; }
function showSummary() {
    closeAll(); const dataByService = {}; let grandLordo = 0;
    for (let i = 1; i <= 31; i++) {
        const key = `${currentYear}-${currentMonth+1}-${i}`;
        const item = JSON.parse(localStorage.getItem(key));
        if (item) { if (!dataByService[item.client]) dataByService[item.client] = []; dataByService[item.client].push({ giorno: i, ...item }); }
    }
    let html = "";
    if (Object.keys(dataByService).length === 0) html = "<p>Nessun dato registrato per questo mese.</p>";
    else {
        for (let service in dataByService) {
            const bg = getColorForCompany(service);
            const border = getBorderColor(service);
            html += `<div class="row-service" style="background:${bg}; border-left:8px solid ${border};">
                        <span>Societ√†: ${service}</span>
                        <button class="btn-excel" onclick="exportDetailedExcel('${service.replace(/'/g, "\\'")}')">üì• Esporta Excel</button>
                     </div>
                     <table>
                     <tr><th>Giorno</th><th>Location</th><th>Inizio</th><th>Fine</th><th>Pausa</th><th>Straord.</th><th>Lordo</th></tr>`;
            let subLordo = 0;
            dataByService[service].forEach(d => {
                const s = getStats(d.startTime, d.endTime, d.lunchBreak);
                html += `<tr><td>${d.giorno}/${currentMonth+1}</td><td>${d.location}</td><td>${d.startTime}</td><td>${d.endTime}</td><td>${d.lunchBreak}</td><td>${s.stra.toFixed(1)}h</td><td>‚Ç¨${s.lordo.toFixed(2)}</td></tr>`;
                subLordo += s.lordo;
            });
            html += `<tr style="font-weight:bold; background:#f9f9f9;"><td colspan="6">Totale Lordo ${service}</td><td>‚Ç¨${subLordo.toFixed(2)}</td></tr></table><br>`;
            grandLordo += subLordo;
        }
        html += `<table><tr class="total-final"><td colspan="6">TOTALE GENERALE MESE</td><td>‚Ç¨${grandLordo.toFixed(2)}</td></tr></table>`;
    }
    document.getElementById("summaryTitle").innerText = `Consuntivo Analitico: ${months[currentMonth]}`;
    document.getElementById("summaryContent").innerHTML = html;
    document.getElementById("summaryBox").style.display = "block";
}

function exportDetailedExcel(serviceTarget) {
    let csv = "Societ√†;Giorno;Location;Inizio;Fine;Pausa pranzo;Straordinari;Lordo\n";
    let found = false;
    let totalLordo = 0; // Inizializza il totale

    for (let i = 1; i <= 31; i++) {
        const item = JSON.parse(localStorage.getItem(`${currentYear}-${currentMonth+1}-${i}`));
        if (item && (serviceTarget === 'tutti' || item.client === serviceTarget)) {
            const s = getStats(item.startTime, item.endTime, item.lunchBreak);
            csv += `${item.client};${i}/${currentMonth+1};${item.location};${item.startTime};${item.endTime};${item.lunchBreak};${s.stra.toFixed(1)};${s.lordo.toFixed(2)}\n`;
            totalLordo += s.lordo; // Accumula il valore lordo
            found = true;
        }
    }
    if(!found) return alert("Nessun dato da esportare.");

    // Aggiunge la riga del totale in fondo al file
    csv += `\n;;;;;;TOTALE LORDO;${totalLordo.toFixed(2)}\n`;

    const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = serviceTarget === 'tutti' ? `Consuntivo_Mese_${months[currentMonth]}.csv` : `Consuntivo_${serviceTarget.replace(/ /g, "_")}.csv`;
    link.click();
}

function showAnnualSummary() {
    closeAll(); let totalNetto = 0, totalGG = 0, monthCount = new Set();
    for (let m=1; m<=12; m++) {
        for (let d=1; d<=31; d++) {
            const data = JSON.parse(localStorage.getItem(`${currentYear}-${m}-${d}`));
            if(data) { const s = getStats(data.startTime, data.endTime, data.lunchBreak); totalNetto += s.netto; totalGG++; monthCount.add(m); }
        }
    }
    const media = monthCount.size ? (totalNetto / monthCount.size) : 0;
    document.getElementById("annualContent").innerHTML = `<div style="padding:20px; background:#e8f0fe; border-radius:10px; font-size:18px;"><p>Giornate totali lavorate: <b>${totalGG}</b></p><p>Netto totale accumulato: <b>‚Ç¨${totalNetto.toFixed(2)}</b></p><p>Media mensile netta: <b>‚Ç¨${media.toFixed(2)}</b></p></div>`;
    document.getElementById("annualBox").style.display = "block";
}
monthSel.onchange = renderCalendar; renderCalendar();
</script>
</body>
</html>
